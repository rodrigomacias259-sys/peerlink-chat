<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PeerLink Chat</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #333;
    }
    h1 {
      text-align: center;
      color: #4a4a4a;
      margin-bottom: 20px;
    }
    #peerId {
      text-align: center;
      font-size: 16px;
      margin-bottom: 15px;
    }
    #remotePeerId {
      width: 60%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-right: 10px;
    }
    #connect {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #connect:hover {
      background-color: #0056b3;
    }
    #chat {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      height: 300px;
      overflow-y: scroll;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    #chat div {
      background-color: #f1f1f1;
      padding: 10px;
      border-radius: 20px;
      margin-bottom: 10px;
      max-width: 80%;
    }
    #chat div:nth-child(even) {
      background-color: #e3f2fd;
      align-self: flex-end;
      margin-left: auto;
    }
    #message {
      width: 70%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-right: 10px;
    }
    #send {
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #send:hover {
      background-color: #218838;
    }
    #startCall, #endCall {
      padding: 10px 20px;
      margin-top: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #startCall {
      background-color: #17a2b8;
      color: white;
    }
    #startCall:hover {
      background-color: #138496;
    }
    #endCall {
      background-color: #dc3545;
      color: white;
    }
    #endCall:hover {
      background-color: #c82333;
    }
    #videos {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    video {
      width: 45%;
      border: 1px solid #ddd;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      background-color: black;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    #incomingCall, #authModal {
      display: none !important;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      text-align: center;
      width: 300px;
      z-index: 1000;
    }
    #authModal[style*="display: block"] {
      display: block !important;
    }
    body.authModalOpen::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      pointer-events: auto;
    }
    #incomingCall button, #authModal button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #acceptCall {
      background-color: #28a745;
      color: white;
    }
    #rejectCall {
      background-color: #dc3545;
      color: white;
    }
    #email, #password, #peerIdInput {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 10px;
      width: 90%;
    }
    #signUpBtn, #loginBtn {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    #signUpBtn:hover, #loginBtn:hover {
      background-color: #0056b3;
    }
    #toggleAuth {
      background-color: transparent;
      border: none;
      color: #007bff;
      cursor: pointer;
    }
    #contacts {
      margin-top: 20px;
    }
    #contacts ul {
      list-style: none;
      padding: 0;
    }
    #contacts li {
      background: #f8f9fa;
      padding: 10px;
      margin-bottom: 5px;
      border-radius: 5px;
      cursor: pointer;
    }
    #contacts li:hover {
      background: #e9ecef;
    }
    #addContactInput {
      width: 60%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-right: 10px;
    }
    #addContactBtn {
      padding: 10px 20px;
      background-color: #ffc107;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #addContactBtn:hover {
      background-color: #e0a800;
    }
    body.dark-mode {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #e0e0e0;
    }
    body.dark-mode .container {
      background: #2a2a2a;
      color: #e0e0e0;
    }
    body.dark-mode #chat {
      background-color: #1a1a1a;
      border-color: #444;
    }
    body.dark-mode #chat div {
      background-color: #333;
      color: #e0e0e0;
    }
    body.dark-mode #chat div:nth-child(even) {
      background-color: #0d47a1;
      color: #e0e0e0;
    }
    body.dark-mode #message, body.dark-mode #remotePeerId, body.dark-mode #addContactInput {
      background-color: #333;
      color: #e0e0e0;
      border-color: #555;
    }
    body.dark-mode #contacts li {
      background: #333;
      color: #e0e0e0;
    }
    body.dark-mode #contacts li:hover {
      background: #444;
    }
    body.dark-mode #authModal {
      background: #2a2a2a;
      color: #e0e0e0;
    }
    body.dark-mode #authModal input {
      background-color: #333;
      color: #e0e0e0;
      border-color: #555;
    }
    body.dark-mode #incomingCall {
      background: #2a2a2a;
      color: #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h1>PeerLink Chat</h1>
      <button id="themeToggle" style="padding: 8px 12px; background-color: #333; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">ðŸŒ™ Dark Mode</button>
    </div>
    <div id="peerId">Your Peer ID: <span id="myPeerId"></span> <button id="logoutBtn" style="margin-left: 20px; padding: 5px 15px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Logout</button></div>
    <input type="text" id="remotePeerId" placeholder="Enter remote peer ID to connect...">
    <button id="connect">Connect</button>
    <div id="chat"></div>
    <input type="text" id="message" placeholder="Type a message...">
    <button id="send">Send</button>
    <button id="startCall">Start Video Call</button>
    <button id="endCall">End Call</button>
    <div id="videos">
      <video id="localVideo" autoplay playsinline muted></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
    <div id="contacts">
      <h3>My Peer ID (Share this with others)</h3>
      <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 10px; word-break: break-all;">
        <span id="sharePeerId" style="font-weight: bold; font-family: monospace; font-size: 14px;"></span>
        <button id="copyPeerIdBtn" style="margin-left: 10px; padding: 5px 10px; background-color: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">Copy</button>
      </div>
      
      <h3>Contacts</h3>
      <ul id="contactsList"></ul>
      <p style="margin-top: 10px; font-weight: bold;">Add a contact by their Peer ID:</p>
      <input type="text" id="addContactInput" placeholder="Paste their Peer ID here...">
      <button id="addContactBtn">Add Contact</button>
    </div>
  </div>

  <div id="incomingCall">
    <p>Incoming call from peer!</p>
    <button id="acceptCall">Accept</button>
    <button id="rejectCall">Reject</button>
  </div>

  <div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>

  <div id="authModal">
    <p id="authTitle">Sign Up</p>
    <div id="authForm">
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button id="signUpBtn">Sign Up</button>
      <button id="toggleAuth">Already have an account? Login</button>
      <button id="forgotPasswordBtn" style="background-color: transparent; border: none; color: #007bff; cursor: pointer; margin-top: 10px;">Forgot Password?</button>
    </div>
    <div id="verificationForm" style="display: none;">
      <p>Verification code sent to your email!</p>
      <input type="text" id="verificationCode" placeholder="Enter verification code">
      <button id="verifyBtn">Verify</button>
      <button id="backBtn">Back</button>
    </div>
    <div id="resetPasswordForm" style="display: none;">
      <p>Enter your email to reset password</p>
      <input type="email" id="resetEmail" placeholder="Email">
      <button id="sendResetCodeBtn">Send Reset Code</button>
      <button id="backFromResetBtn">Back</button>
    </div>
    <div id="newPasswordForm" style="display: none;">
      <p>Enter your new password</p>
      <input type="text" id="resetCode" placeholder="Enter reset code">
      <input type="password" id="newPassword" placeholder="New password">
      <button id="confirmResetBtn">Reset Password</button>
      <button id="backFromNewPasswordBtn">Back</button>
    </div>
    <div id="testUserForm" style="display: none; text-align: left;">
      <p>Create a test user to chat with</p>
      <input type="text" id="testUsername" placeholder="Test username (e.g., alice, bob)">
      <button id="createTestUserBtn" style="width: 100%; margin-top: 10px;">Create Test User</button>
      <button id="backFromTestBtn" style="width: 100%; background-color: #6c757d;">Back</button>
    </div>
  </div>

  <button id="createTestUserBtnBottom" style="position: fixed; bottom: 20px; right: 20px; padding: 10px 15px; background-color: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer; z-index: 100;">+ Test User</button>

  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <script>
    // Local storage based authentication (no Firebase needed)
    let auth = null;
    let db = null;
    let currentUser = null;
    let isSignUp = true;

    // Initialize local storage auth
    function initializeAuth() {
      console.log('initializeAuth called');
      const modalOverlay = document.getElementById('modalOverlay');
      // Check if user is already logged in
      const savedUser = localStorage.getItem('currentUser');
      console.log('Saved user:', savedUser);
      console.log('Auth modal element:', authModal);
      
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        authModal.style.display = 'none';
        modalOverlay.style.display = 'none';
        loadUserData();
      } else {
        // Force show auth modal with overlay
        authModal.style.cssText = 'display: block !important;';
        modalOverlay.style.display = 'block';
        console.log('Auth modal display set to block');
      }
    }

    // Get all users from local storage
    function getAllUsers() {
      const users = localStorage.getItem('allUsers');
      return users ? JSON.parse(users) : {};
    }

    // Save users to local storage
    function saveAllUsers(users) {
      localStorage.setItem('allUsers', JSON.stringify(users));
    }

    // Logout function
    function logout() {
      localStorage.removeItem('currentUser');
      currentUser = null;
      document.getElementById('modalOverlay').style.display = 'block';
      authModal.style.cssText = 'display: block !important;';
      chat.innerHTML = '';
      myPeerIdSpan.textContent = '';
      if (peer) peer.destroy();
    }

    // Function to send verification email via Vercel API
    async function sendVerificationEmail(email, code) {
      try {
        const response = await fetch('https://formspree.io/f/mnqkalae', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: email,
            subject: 'PeerLink Verification Code',
            message: `Your verification code is: ${code}\n\nThis code expires in 10 minutes.`
          })
        });
        return response.ok;
      } catch (error) {
        console.error('Email error:', error);
        return false;
      }
    }

    // Function to send reset email via Formspree
    async function sendResetEmail(email, code) {
      try {
        const response = await fetch('https://formspree.io/f/mnqkalae', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: email,
            subject: 'PeerLink Password Reset Code',
            message: `Your password reset code is: ${code}\n\nThis code expires in 10 minutes.`
          })
        });
        return response.ok;
      } catch (error) {
        console.error('Email error:', error);
        return false;
      }
    }

    // Initialize on page load after DOM is ready
    window.addEventListener('DOMContentLoaded', () => {
      initializeAuth();
    });
    
    // Fallback: also try immediately in case DOM is already loaded
    if (document.readyState === 'loading') {
      // Still loading
    } else {
      // Already loaded
      setTimeout(initializeAuth, 10);
    }

    const chat = document.getElementById('chat');
    const messageInput = document.getElementById('message');
    const sendBtn = document.getElementById('send');
    const connectBtn = document.getElementById('connect');
    const remotePeerIdInput = document.getElementById('remotePeerId');
    const myPeerIdSpan = document.getElementById('myPeerId');
    const startCallBtn = document.getElementById('startCall');
    const endCallBtn = document.getElementById('endCall');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const incomingCallDiv = document.getElementById('incomingCall');
    const acceptCallBtn = document.getElementById('acceptCall');
    const rejectCallBtn = document.getElementById('rejectCall');
    const authModal = document.getElementById('authModal');
    const authTitle = document.getElementById('authTitle');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const signUpBtn = document.getElementById('signUpBtn');
    const toggleAuthBtn = document.getElementById('toggleAuth');
    const contactsList = document.getElementById('contactsList');
    const addContactInput = document.getElementById('addContactInput');
    const addContactBtn = document.getElementById('addContactBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const themeToggle = document.getElementById('themeToggle');
    const copyPeerIdBtn = document.getElementById('copyPeerIdBtn');
    const sharePeerId = document.getElementById('sharePeerId');

    let peer;
    let conn;
    let call;
    let localStream;
    let pendingCall;
    let tempSignUpData = null; // Store signup data during verification
    let verificationCode = null; // Store the sent verification code
    let resetCode = null; // Store reset code
    let resetEmail = null; // Store email for password reset

    // Initialize theme from localStorage
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
      themeToggle.textContent = 'â˜€ï¸ Light Mode';
    }

    // Theme toggle handler
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      themeToggle.textContent = isDark ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
    });

    // Copy Peer ID button
    copyPeerIdBtn.addEventListener('click', () => {
      const peerId = sharePeerId.textContent;
      navigator.clipboard.writeText(peerId);
      copyPeerIdBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyPeerIdBtn.textContent = 'Copy';
      }, 2000);
    });

    toggleAuthBtn.addEventListener('click', () => {
      isSignUp = !isSignUp;
      authTitle.textContent = isSignUp ? 'Sign Up' : 'Login';
      signUpBtn.textContent = isSignUp ? 'Sign Up' : 'Login';
      toggleAuthBtn.textContent = isSignUp ? 'Already have an account? Login' : 'Need an account? Sign Up';
    });

    logoutBtn.addEventListener('click', logout);

    // Verification button
    const verifyBtn = document.getElementById('verifyBtn');
    const backBtn = document.getElementById('backBtn');
    const verificationCodeInput = document.getElementById('verificationCode');
    
    verifyBtn.addEventListener('click', () => {
      const enteredCode = verificationCodeInput.value.trim();
      console.log('Verification code entered:', enteredCode);
      console.log('Expected code:', verificationCode);
      
      if (enteredCode !== verificationCode) {
        alert('Incorrect verification code');
        return;
      }
      
      // Code is correct, create the user
      console.log('Verification successful, creating user');
      const allUsers = getAllUsers();
      const email = tempSignUpData.email;
      const password = tempSignUpData.password;
      
      const username = email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');
      const randomSuffix = Math.random().toString(36).substring(2, 8);
      const peerId = username + '_' + randomSuffix;
      
      allUsers[email] = {
        email: email,
        password: password,
        peerId: peerId,
        contacts: [],
        createdAt: new Date().toISOString(),
        verified: true
      };
      
      saveAllUsers(allUsers);
      
      currentUser = {
        email: email,
        peerId: peerId
      };
      
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      authModal.style.display = 'none';
      document.getElementById('modalOverlay').style.display = 'none';
      myPeerIdSpan.textContent = peerId;
      appendMessage('System: Welcome! Your Peer ID is ' + peerId);
      initializePeer(peerId);
      
      // Reset forms
      document.getElementById('authForm').style.display = 'block';
      document.getElementById('verificationForm').style.display = 'none';
      verificationCodeInput.value = '';
      tempSignUpData = null;
      verificationCode = null;
      
      console.log('User created with Peer ID:', peerId);
    });
    
    backBtn.addEventListener('click', () => {
      document.getElementById('authForm').style.display = 'block';
      document.getElementById('verificationForm').style.display = 'none';
      verificationCodeInput.value = '';
      tempSignUpData = null;
      verificationCode = null;
    });

    // Password reset
    const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
    const sendResetCodeBtn = document.getElementById('sendResetCodeBtn');
    const confirmResetBtn = document.getElementById('confirmResetBtn');
    const backFromResetBtn = document.getElementById('backFromResetBtn');
    const backFromNewPasswordBtn = document.getElementById('backFromNewPasswordBtn');
    
    forgotPasswordBtn.addEventListener('click', () => {
      document.getElementById('authForm').style.display = 'none';
      document.getElementById('resetPasswordForm').style.display = 'block';
    });
    
    sendResetCodeBtn.addEventListener('click', async () => {
      resetEmail = document.getElementById('resetEmail').value.trim();
      console.log('Reset requested for email:', resetEmail);
      
      const allUsers = getAllUsers();
      if (!allUsers[resetEmail]) {
        alert('Email not found');
        return;
      }
      
      // Generate reset code
      resetCode = String(Math.floor(Math.random() * 999999)).padStart(6, '0');
      console.log('Generated reset code:', resetCode);
      
      // Show new password form
      document.getElementById('resetPasswordForm').style.display = 'none';
      document.getElementById('newPasswordForm').style.display = 'block';
      
      // Send reset email
      const emailSent = await sendResetEmail(resetEmail, resetCode);
      if (emailSent) {
        alert('Reset code sent to ' + resetEmail);
      } else {
        alert('Failed to send email. Please try again.');
      }
    });
    
    confirmResetBtn.addEventListener('click', () => {
      const enteredCode = document.getElementById('resetCode').value.trim();
      const newPassword = document.getElementById('newPassword').value.trim();
      
      console.log('Reset code entered:', enteredCode);
      console.log('New password provided:', newPassword ? 'yes' : 'no');
      
      if (enteredCode !== resetCode) {
        alert('Incorrect reset code');
        return;
      }
      
      if (!newPassword) {
        alert('Please enter a new password');
        return;
      }
      
      // Update password
      const allUsers = getAllUsers();
      allUsers[resetEmail].password = newPassword;
      saveAllUsers(allUsers);
      
      console.log('Password reset successful');
      alert('Password reset successful! You can now log in with your new password.');
      
      // Reset forms
      document.getElementById('newPasswordForm').style.display = 'none';
      document.getElementById('authForm').style.display = 'block';
      document.getElementById('resetEmail').value = '';
      document.getElementById('resetCode').value = '';
      document.getElementById('newPassword').value = '';
      resetCode = null;
      resetEmail = null;
    });
    
    backFromResetBtn.addEventListener('click', () => {
      document.getElementById('resetPasswordForm').style.display = 'none';
      document.getElementById('authForm').style.display = 'block';
      document.getElementById('resetEmail').value = '';
    });
    
    backFromNewPasswordBtn.addEventListener('click', () => {
      document.getElementById('newPasswordForm').style.display = 'none';
      document.getElementById('resetPasswordForm').style.display = 'block';
      document.getElementById('resetCode').value = '';
      document.getElementById('newPassword').value = '';
    });

    // Test user creation
    const createTestUserBtnBottom = document.getElementById('createTestUserBtnBottom');
    const createTestUserBtn = document.getElementById('createTestUserBtn');
    const backFromTestBtn = document.getElementById('backFromTestBtn');
    const testUsernameInput = document.getElementById('testUsername');
    
    createTestUserBtnBottom.addEventListener('click', () => {
      document.getElementById('authForm').style.display = 'none';
      document.getElementById('resetPasswordForm').style.display = 'none';
      document.getElementById('newPasswordForm').style.display = 'none';
      document.getElementById('verificationForm').style.display = 'none';
      document.getElementById('testUserForm').style.display = 'block';
    });
    
    createTestUserBtn.addEventListener('click', () => {
      const username = testUsernameInput.value.trim();
      
      if (!username) {
        alert('Please enter a username');
        return;
      }
      
      const allUsers = getAllUsers();
      const testEmail = username + '@testuser.local';
      
      if (allUsers[testEmail]) {
        alert('Test user already exists');
        return;
      }
      
      // Create test user
      const testPeerId = username + '_test_' + Math.random().toString(36).substring(2, 8);
      allUsers[testEmail] = {
        email: testEmail,
        password: 'test123',
        peerId: testPeerId,
        contacts: [],
        createdAt: new Date().toISOString(),
        isTestUser: true
      };
      
      saveAllUsers(allUsers);
      
      console.log('Test user created:', {
        email: testEmail,
        password: 'test123',
        peerId: testPeerId
      });
      
      alert('Test user created!\n\nEmail: ' + testEmail + '\nPassword: test123\nPeer ID: ' + testPeerId + '\n\nYou can now add this user as a contact!');
      
      // Reset form
      testUsernameInput.value = '';
      document.getElementById('testUserForm').style.display = 'none';
      document.getElementById('authForm').style.display = 'block';
    });
    
    backFromTestBtn.addEventListener('click', () => {
      document.getElementById('testUserForm').style.display = 'none';
      document.getElementById('authForm').style.display = 'block';
      testUsernameInput.value = '';
    });

    signUpBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      
      console.log('Sign up clicked - isSignUp:', isSignUp);
      console.log('Email:', email);
      console.log('Password:', password ? '***' : 'empty');
      
      if (!email || !password) {
        alert('Please enter email and password');
        return;
      }

      try {
        const allUsers = getAllUsers();
        console.log('All users:', Object.keys(allUsers));
        
        if (isSignUp) {
          // Sign up
          console.log('Attempting sign up for:', email);
          if (allUsers[email]) {
            alert('Email already registered');
            console.log('Email already exists');
            return;
          }
          
          // Generate a 6-digit verification code
          verificationCode = String(Math.floor(Math.random() * 999999)).padStart(6, '0');
          console.log('Generated verification code:', verificationCode);
          
          // Store temp signup data
          tempSignUpData = {
            email: email,
            password: password
          };
          
          // Show verification form
          document.getElementById('authForm').style.display = 'none';
          document.getElementById('verificationForm').style.display = 'block';
          
          // Send verification email
          const emailSent = await sendVerificationEmail(email, verificationCode);
          if (emailSent) {
            alert('Verification code sent to ' + email);
          } else {
            alert('Failed to send email. Please try again.');
          }
          console.log('Showing verification form');
          
        } else {
          // Login
          console.log('Attempting login for:', email);
          console.log('Email exists?', email in allUsers);
          
          if (!allUsers[email]) {
            alert('Email not found');
            console.log('Email not in users');
            return;
          }
          
          console.log('User data:', allUsers[email]);
          console.log('Entered password:', password);
          console.log('Stored password:', allUsers[email].password);
          console.log('Passwords match?', allUsers[email].password === password);
          
          if (allUsers[email].password !== password) {
            alert('Incorrect password');
            console.log('Password mismatch');
            return;
          }
          
          const userData = allUsers[email];
          console.log('Login validation passed, userData:', userData);
          
          currentUser = {
            email: email,
            peerId: userData.peerId
          };
          
          console.log('Login successful, setting currentUser');
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          authModal.style.display = 'none';
          document.getElementById('modalOverlay').style.display = 'none';
          myPeerIdSpan.textContent = userData.peerId;
          appendMessage('System: Welcome back! Your Peer ID is ' + userData.peerId);
          console.log('About to initialize peer with:', userData.peerId);
          initializePeer(userData.peerId);
          loadContacts(userData.contacts || []);
          console.log('User logged in');
        }
      } catch (err) {
        console.error('Auth error:', err);
        console.error('Stack:', err.stack);
        alert('Error: ' + err.message);
      }
    });

    async function loadUserData() {
      try {
        if (currentUser && currentUser.email) {
          const allUsers = getAllUsers();
          const userData = allUsers[currentUser.email];
          
          if (userData && userData.peerId) {
            console.log('User data loaded:', userData);
            initializePeer(userData.peerId);
            loadContacts(userData.contacts || []);
          } else {
            console.error('No user data found');
            appendMessage('System: Error loading user data.');
          }
        }
      } catch (err) {
        console.error('Error loading user data:', err);
        appendMessage('System: Error loading user data: ' + err.message);
      }
    }

    function initializePeer(id) {
      try {
        peer = new Peer(id);

        peer.on('open', (openedId) => {
          myPeerIdSpan.textContent = openedId;
          appendMessage('System: Your Peer ID is ' + openedId + '. Share it to connect.');
        });

        peer.on('error', (err) => console.error('Peer error:', err));

        peer.on('connection', (incomingConn) => {
          conn = incomingConn;
          setupConnection();
          appendMessage('System: Connected to ' + conn.peer);
        });

        peer.on('call', (incomingCall) => {
          pendingCall = incomingCall;
          incomingCallDiv.style.display = 'block';
          appendMessage('System: Incoming call...');
        });
      } catch (err) {
        console.error('Error initializing Peer:', err);
        appendMessage('System: Error initializing Peer: ' + err.message);
      }
    }

    function loadContacts(contacts) {
      contactsList.innerHTML = '';
      contacts.forEach((contactId) => {
        const li = document.createElement('li');
        li.textContent = contactId;
        li.addEventListener('click', () => {
          remotePeerIdInput.value = contactId;
          conn = peer.connect(contactId);
          setupConnection();
          appendMessage('System: Connecting to contact ' + contactId);
        });
        contactsList.appendChild(li);
      });
    }

    addContactBtn.addEventListener('click', async () => {
      const contactId = addContactInput.value.trim();
      if (contactId && currentUser) {
        const allUsers = getAllUsers();
        const userData = allUsers[currentUser.email];
        
        if (!userData.contacts) {
          userData.contacts = [];
        }
        
        if (!userData.contacts.includes(contactId)) {
          userData.contacts.push(contactId);
          saveAllUsers(allUsers);
          loadUserData();
          addContactInput.value = '';
          alert('Contact added!');
        } else {
          alert('Contact already added');
        }
      }
    });

    acceptCallBtn.addEventListener('click', () => {
      incomingCallDiv.style.display = 'none';
      if (pendingCall) {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
          .then((stream) => {
            localStream = stream;
            localVideo.srcObject = stream;
            pendingCall.answer(stream);
            call = pendingCall;
            setupCall();
            appendMessage('System: Call accepted.');
          })
          .catch((err) => console.error('Error accepting call:', err));
        pendingCall = null;
      }
    });

    rejectCallBtn.addEventListener('click', () => {
      incomingCallDiv.style.display = 'none';
      if (pendingCall) {
        pendingCall.close();
        pendingCall = null;
        appendMessage('System: Call rejected.');
      }
    });

    connectBtn.addEventListener('click', () => {
      const remoteId = remotePeerIdInput.value.trim();
      if (remoteId && peer) {
        conn = peer.connect(remoteId);
        setupConnection();
      }
    });

    function setupConnection() {
      conn.on('data', (data) => {
        appendMessage('Remote: ' + data);
      });

      conn.on('close', () => {
        appendMessage('System: Connection closed.');
      });

      sendBtn.addEventListener('click', sendMessage);
    }

    function sendMessage() {
      const msg = messageInput.value.trim();
      if (msg && conn && conn.open) {
        conn.send(msg);
        appendMessage('You: ' + msg);
        messageInput.value = '';
      }
    }

    startCallBtn.addEventListener('click', () => {
      const remoteId = remotePeerIdInput.value.trim();
      if (remoteId && peer) {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
          .then((stream) => {
            localStream = stream;
            localVideo.srcObject = stream;
            call = peer.call(remoteId, stream);
            setupCall();
            appendMessage('System: Calling...');
          })
          .catch((err) => console.error('Error starting call:', err));
      }
    });

    function setupCall() {
      call.on('stream', (remoteStream) => {
        remoteVideo.srcObject = remoteStream;
      });

      call.on('close', endCall);
    }

    endCallBtn.addEventListener('click', endCall);

    function endCall() {
      if (call) call.close();
      if (localStream) localStream.getTracks().forEach(track => track.stop());
      localVideo.srcObject = null;
      remoteVideo.srcObject = null;
      appendMessage('System: Call ended.');
    }

    function appendMessage(msg) {
      const div = document.createElement('div');
      div.textContent = msg;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
  </script>
</body>
</html>